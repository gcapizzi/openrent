<html>
    <head>
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin=""/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    </head>
    <body>
        <div id="map" style="height: 600px"></div>
        <form enctype="multipart/form-data" method="post" name="kml-file" id="kml-file">
            <p>
                <input type="file" name="file" required />
                <input type="submit" value="Load" />
            </p>
        </form>
        <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>
        <script>
            var center = [51.505, -0.09];
            var radius = 30000;
            let zoom = 12;
            var map = L.map('map').setView(center, zoom);
            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);

            const form = document.querySelector("#kml-file");
            form.addEventListener("submit", (event) => {
                const formData = new FormData(form);
                fetch("/search", { method: "POST", body: formData, })
                    .then((response) => response.json())
                    .then((response) => {
                        map.eachLayer((l) => {
                            if (l instanceof L.Marker || l instanceof L.Polygon) {
                                map.removeLayer(l)
                            }
                        })

                        response.properties
                            .filter((p) => {
                                console.log(p);
                                return p.studio == false && 
                                    p.shared == false &&
                                    p.price >= 1500 && p.price <= 2000 &&
                                    p.bedrooms >= 1 && p.bedrooms <= 2
                            }).forEach((p) => {
                                L.marker([p.latitude, p.longitude])
                                    .bindPopup(`<a href="${p.url}" target="_blank"><strong>#${p.id}</strong></a><br>Price: ${p.price}<br>Bedrooms: ${p.bedrooms}`)
                                    .addTo(map);
                            });

                        var latlngs = response.polygons.map((p) => [p.external, ...p.internals]);
                        var polygon = L.polygon(latlngs).addTo(map);
                        map.fitBounds(polygon.getBounds());
                    });
                event.preventDefault();
            });
        </script>
    </body>
</html>
